input: {
	network: #Network @name(Network)
	subdomain: string @name(Subdomain)
}

_domain: "\(input.subdomain).\(input.network.domain)"
url: "https://\(_domain)"

name: "Jenkins"
namespace: "app-jenkins"
readme: "Jenkins CI/CD"
description: "Build great things at any scale. The leading open source automation server, Jenkins provides hundreds of plugins to support building, deploying and automating any project."
icon: """
<svg width='50px' height='50px' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 35.98188688 39.68503937'>
  <defs>
    <style>
      .cls-1 {
        fill: currentColor;
      }

      .cls-2 {
        fill: none;
        stroke: #3a3a3a;
        stroke-miterlimit: 10;
        stroke-width: .98133445px;
      }
    </style>
  </defs>
  <rect class='cls-2' x='-11.82596649' y='-9.97439025' width='59.63381987' height='59.63381987'/>
  <path class='cls-1' d='m2.89767408,39.68503937h-1.61221736c-.04151253-.10751988-.08010966-.21614364-.11574902-.32575141-.35551464-1.10126905-.98221237-2.46379839-1.14426076-3.56175899-.24141925-1.62709809,1.28977381-1.71804418,2.27198598-2.42246012,1.51300388-1.09134685,2.7035648-1.6948945,4.34389196-2.67876247.48779921-.29598798,1.95450372-1.03181999,2.11820575-1.37079889.33236515-.67464935-.57047655-1.62379279-.81024217-2.14962183-.37204999-.83835295-.57047655-1.54938263-.62173702-2.3728523-1.36253013-.2149625-2.40592418-1.03677951-3.04915745-1.95946324-1.04174061-1.52953982-1.76269091-4.35712102-.86811717-6.50839708.07441016-.17031577.4200032-.50433515.47126367-.76559702.09921328-.50929467-.17362343-1.19056092-.19842656-1.73292748-.09921328-2.79781698.46960983-5.20870226,2.35631754-6.05201552.76559623-3.0425437,3.49396416-4.05617353,6.07351256-5.56752397.95906248-.56551624,2.02395278-.92929856,3.12522183-1.33441984,3.92223493-1.45016876,9.96598406-1.17733205,13.21852758,1.29473461,1.38237373,1.04670112,3.59813932,3.25750581,4.39184555,4.85980156,2.08678651,4.22483586,1.93466091,11.28552011.47457172,16.42642833-.19842813.69614639-.47953282,1.70646934-.88134388,2.53490168-.27779623.57874373-1.13929887,1.73623435-1.03347264,2.24883589.10582624.51921529,1.96773279,1.93466091,2.3678912,2.30671169.71764343.69780219,2.08348122,1.61221795,2.18930745,2.48033433.11574843.9210295-.41008061,2.20915184-.6779578,3.10041792-.35882014,1.19221515-.72095188,2.38277449-1.08142466,3.52372917H2.89436681l.00330727.02645498Zm18.36108805-5.85359054c-1.07265206-.57801045-2.22250865-.99953028-3.41459448-1.25174201-1.43859372-.27118249-1.28977341,1.96442434-1.24016717,3.29719025.04960625,1.06323607.59527967,2.17607996.84331405,2.88380119.12567063.32575141.14882031.6779578.42330967.74244576.49606718.11244314,2.13308746-.53905968,2.60435073-.79205358.99213436-.54236498,1.75938404-1.39560122,2.60269809-1.96607699.02645656-.28110468.02645656-.56220937.04960625-.8400056-.56358289-.28112045-1.18117962-.43735245-1.81064451-.45803578.51921687-.2480328,1.24016717-.2480328,1.71143044-.54898188l.02645656-.31913766c-.82016437-.04960782-1.1409531-.4200028-1.68828075-.72095188l-.10747888-.02645183Zm12.32560886,4.85318663c.30539293-.95197565.56202644-1.91891029.7689039-2.89703184.09921249-.47457172.35551484-1.5179634.29433217-1.9445831-.09755984-.7589817-1.13103248-1.32119107-1.66016997-1.79576279-.96567623-.86811639-1.57087967-1.61221795-2.57954682-2.42907386-.41173641.62008358-1.28977499,1.0169367-1.62544544,1.51134966,2.39269669-1.13929887,2.82757963,4.34058508,1.88670889,6.10162334.14882031.54402078.64654172.74410156.8499278,1.21536483l-.14220657.27449094h2.13308904c.02149704,0,.04960782,0,.07275751.02314969l.00164949-.05952686Zm-10.96969169-.01984124c-.08267813-.12236218-.16535625-.22323047-.2480328-.34559264l-.49771983.32244296h.74409998l.00165265.02314969Zm4.58034992,0c.01322749-.34559264.02976343-.6680356.04960782-.98882591-.87638593.04795202-1.36418514-.79370623-1.97765183-.87142484-.53575123-.07441016-.99213436.5969339-1.6866281.32244296-.15708828.17362265-.30260015.37535608-.46961062.52252374.25464813.29764062.48779921.62008358.70110749.96567623h1.3476492c.01156223-.26499767.23082193-.47329439.49606561-.47126327.27283829,0,.46961062.20008078.46961062.44646094h1.09134685l-.02149704.07441016Zm3.49892368,0c-.51921529-.79205358-1.56591858-1.48489467-2.77797496-.91772421l-.04960782.89457452h2.82758278v.02314969Zm-14.07176383,0l-.17197-.56882311c-.37205078-1.19055934-.59527967-2.08348122-.66968983-2.77797496-1.51134966-.72095188-3.10041792-1.4385953-4.38853868-2.35797216-.24803359-.17362265-1.83379419-2.23230153-2.03387419-2.15789137-2.87553401,1.11780499-5.5542953,3.07561558-7.96021987,4.93421053.42331046.9210295.79370702,1.88670889,1.14095389,2.87718745h14.06349586l.01984281.05126362Zm13.66664432-3.49396258c-.04795202-.84661935-.27118249-2.57954682-.79370623-2.87718745-1.09134685-.64488592-3.0524659,1.28977499-3.86932181,1.55930483.07441016.2480328.22323047.44811358.2480328.79370623.47126327-.12236218,1.06654452-.04795202,1.48489467.15212561-.49441296.04960782-1.04008638.04960782-1.36252934.27118249-.12236218.32244296.02645814.79370623-.04795202,1.26331685,1.14095468.32575141,2.48033433.5010267,3.94373197.54898188.27118249-.37535608.37205078-1.06654452.34890109-1.78914904l.04794887.07771861Zm-6.74650926-.59528125c-.07275593.62008358.0760628.84331405.19842656,1.55930483,2.08347964.64654172,1.70977621-2.87718745-.22323047-1.58575981l.02480391.02645498Zm-10.9085106-2.33151402c-.74409998.7556764,2.10001716,1.78914904,2.9995512,1.84371481,0-.47953282.27283671-.93260435.22323047-1.27323905-1.07481091-.19511968-2.48364121-.06944906-3.21616635-.57378421l-.00661532.00330845Zm9.20204126.35551484c0,.07110171-.10086672.04960782-.11244156.10582624.95906248.74575421,1.67670591.90118827,2.97970997.84331405.58535905-.43323029,1.1078828-.9309517,1.72465793-1.33441856-1.41378981.12236218-3.19301666,1.00370921-4.58696524.38031717l-.0049611.0049611ZM27.49101719,3.28861389c-2.65561278-1.49812197-7.1929702-2.63080789-10.04700796-1.20874951-2.28190778,1.14426076-5.4071296,3.0425437-6.44721599,5.44350678.99213436,2.31828574-.27449015,4.4414518-.37370343,6.79446286-.02976422,1.25174201.59528046,2.34804996.64654014,3.70727401-.33071093.5589025-1.36418357.62835155-2.08348122.58866593-.24141906-1.20544264-.66142265-2.56135824-1.909857-2.69529683-1.75938404-.19181281-3.05081128,1.26331685-3.12522104,2.78293448-.09921328,1.78584059,1.37741264,4.73578555,3.44766479,4.53901164.8069353-.0760628,1.00536186-.8929203,1.88340044-.8929203.47126327.94252654-.7358328,1.24016717-.8648103,1.90820435-.02645656.17362265.09921328.8449667.17197,1.16575701.38527827,1.56095748,1.23024576,3.57168119,2.05867731,4.76224369,1.05000858,1.48819997,3.11529963,1.73788857,5.33933319,1.88670889.39685311-.86811639,1.86025075-.79370623,2.82096746-.57213156-1.14260732-.44646094-2.20915027-1.56261013-3.10041792-2.52828635-1.0169367-1.11780499-2.03387497-2.33151402-2.08513387-3.77010775,1.909857,2.65230276,3.47246712,4.96066709,6.94493582,6.12477145,2.62915465.86811639,5.70477023-.4200028,7.71218549-1.83379261.84331405-.59362545,1.34103546-1.53780779,1.93466091-2.37946604,2.23230153-3.20128463,3.27404056-7.78824987,3.0524659-12.2263948-.09921249-1.83710106-.09921249-3.6725479-.72095188-4.88625851-.64323327-1.29142764-2.80277729-2.43238074-4.09255228-1.29142764-.2480328-1.26331685,1.04173903-2.03387419,2.55474449-1.58741404-1.09134685-1.41213717-2.20915184-3.07230753-3.74695964-3.94207814l.02976659.110783Zm-6.88706318,21.34244948c1.0169367,2.55309184,4.50428869,2.25379857,7.44926939,2.18765481-.13889812.32079031-.42331125.71929607-.7689039.85158045-.94252654.38362562-3.54687885.67464935-4.85649508-.01984124-.83669873-.44646094-1.36253092-1.44355482-1.82221935-2.02891388-.22653734-.28441156-1.31457732-1.00536186-.01984281-1.00701608l.01819174.01653594Zm.27118249-1.43859372c1.47662513.76724967,4.16696244.85488889,6.1694166.79370623.10913469.44149984.10913469.98055952.11244314,1.50969701-2.56301246.13228437-5.59894084-.50268093-6.27359177-2.30671011h-.00826797v.00330687Zm11.03748652-.96898468c-.78213139,1.48819997-1.89332263,3.13679667-4.19837852,3.18805714-.03803298-.46961062-.07441016-1.21536326,0-1.49481529,1.75938246-.17031577,2.85569041-1.06819717,4.20499226-1.68166701l-.00661375-.01157484Zm-1.07315827-1.1029217c-1.6866281,1.09134685-3.56175899,2.27363981-6.32319801,2.00080309-.58039796-.51260312-.8019742-1.65355622-.23149844-2.41088527.29929327.51756264.09921407,1.46339764.94252812,1.60394998,1.56095748.27283671,3.36994776-.95740826,4.51420773-1.38898748.69449374-1.17898608-.0760628-1.6138706-.69449374-2.36954542-1.29308028-1.53780779-3.02600776-3.4724687-2.97970839-5.80398272.51921529-.37039656.57213156.57212999.64654172.74409998.6680356,1.58741404,2.35466371,3.5964851,3.59483087,4.96066867.29764062.34724687.79370623.64488749.84331405.86646374.15212561.64488749-.4200028,1.41213717-.34559264,1.83544684l.03306873-.0380314Zm-22.22214229-1.11615077c-.51921687-.30425437-.6498478-1.63702028-1.26993139-1.67009216-.88465233-.04960625-.72425796,1.73623435-.7209503,2.77797496-.61181561-.54567343-.71929686-2.25710387-.27118328-3.12522183-.50929546-.2480328-.7358328.27118249-1.0218978.46961062.36378202-2.62915465,3.86932181-1.21371061,3.2905765,1.58741404l-.00661375-.03968563Zm-2.67545165-10.09165311c-1.13268592,1.25008857-.8929203,3.59483087-.75898249,5.27153678,2.05702387-1.29804138,4.79200554.09921407,4.76720242,2.30505746.98386561-.02645656.36874312-1.23024655.19015859-2.00907106-.58370562-2.52663371.9789053-5.26988413.06779562-7.58982331-1.75938404.13889891-3.20624573.8598492-4.26286805,2.00907106l-.00330608.01322907Zm15.08043335,1.84040794c.50764203.92929826.66803718,1.89828215,1.38898748,2.59608276.32244296.31417499.94914186.70110749.6399264,1.5708781-.07441016.20008078-.60354764.64654014-.91110889.74409998-1.11449654.32244296-3.72711525.04960625-2.84576979-1.33938123.9309517.02480391,2.17277309.59527967,2.86395996-.07441016-.51921687-.86646374-1.46339764-2.52994058-1.11449654-3.52207494l-.02149862.02480549Zm10.24874139-.02149625h.11244314c.54567343,1.10457513.99213436,2.27363902,1.66016997,3.24923744-.44646094,1.03843374-3.39475009,1.96773279-3.34514542.09425297.64488592-.28110468,1.73623277-.05787422,2.30671169-.41338906-.31913766-.91937686-.79370623-1.66347763-.71764343-2.92844792l-.01653594-.00165344Zm-11.45418403-2.67380058c-2.35135683-.54567343-3.52372917.9789053-4.23310305,2.56797277-.6349653-.15543406-.3819714-1.01693749-.22323047-1.46008997.42165703-1.15914327,2.11655152-2.70025714,3.50388478-2.49025574.59362702.09425297,1.40221497.63827296.95244874,1.37906607v.00330687Zm-5.72461147-6.42406532c-2.57954682.72756464-5.88666006,2.6026975-6.94493582,4.91767597.81851014-.11574922,1.38898748-.53079171,2.19922965-.58039796.30756124-.02645656.70772202.12236296,1.0599292.02480312.70110749-.17197,1.28977341-1.76103747,1.82221935-2.33151402.51260312-.57047694,1.13268671-.82016397,1.55434216-1.33938045.27614359-.14882012.67630515-.12236316.69449374-.54567362-.12070953-.1240168-.2480328-.22323007-.38362562-.17362343l-.00165265.02811039Z'/>
</svg>"""

_jenkinsServiceHTTPPortNumber: 80

out: {
	ingress: {
		jenkins: {
			auth: enabled: false
			network: input.network
			subdomain: input.subdomain
			service: {
				name: "jenkins"
				port: number: _jenkinsServiceHTTPPortNumber
			}
		}
	}

	images: {
		jenkins: {
			repository: "jenkins"
			name: "jenkins"
			tag: "2.452-jdk17"
			pullPolicy: "IfNotPresent"
		}
	}

	charts: {
		jenkins: {
			kind: "GitRepository"
			address: "https://code.v1.dodo.cloud/helm-charts"
			branch: "main"
			path: "charts/jenkins"
		}
		oauth2Client: {
			kind: "GitRepository"
			address: "https://code.v1.dodo.cloud/helm-charts"
			branch: "main"
			path: "charts/oauth2-client"
		}
	}

	volumes: jenkins: size: "10Gi"

	helm: {
		"oauth2-client": {
			chart: charts.oauth2Client
			info: "Creating OAuth2 client"
			values: {
				name: "\(release.namespace)-jenkins"
				secretName: _oauth2ClientCredentials
				grantTypes: ["authorization_code"]
				scope: "openid profile email offline offline_access"
				hydraAdmin: "http://hydra-admin.\(global.id)-core-auth.svc.cluster.local"
				redirectUris: ["https://\(_domain)/securityRealm/finishLogin"]
				tokenEndpointAuthMethod: "client_secret_post"
			}
		}
		jenkins: {
			chart: charts.jenkins
			info: "Installing Jenkins server"
			values: {
				fullnameOverride: "jenkins"
				controller: {
					image: {
						repository: images.jenkins.imageName
						tag: images.jenkins.tag
						pullPolicy: images.jenkins.pullPolicy
					}
					jenkinsUrlProtocol: "https://"
					jenkinsUrl: _domain
					sidecars: configAutoReload: enabled: false
					ingress: enabled: false
					servicePort: _jenkinsServiceHTTPPortNumber
					installPlugins: [
						"kubernetes:4203.v1dd44f5b_1cf9",
						"workflow-aggregator:596.v8c21c963d92d",
						"git:5.2.1",
						"configuration-as-code:1836.vccda_4a_122a_a_e",
						"gerrit-code-review:0.4.9",
						"oic-auth:4.239.v325750a_96f3b_",
					]
					additionalExistingSecrets: [{
						name: _oauth2ClientCredentials
						keyName: _oauth2ClientId
					}, {
						name: _oauth2ClientCredentials
						keyName: _oauth2ClientSecret
					}]
					JCasC: {
						defaultConfig: true
						overwriteConfiguration: false
						securityRealm: """
oic:
  clientId: "${\(_oauth2ClientCredentials)-\(_oauth2ClientId)}"
  clientSecret: "${\(_oauth2ClientCredentials)-\(_oauth2ClientSecret)}"
  wellKnownOpenIDConfigurationUrl: "https://hydra.\(networks.public.domain)/.well-known/openid-configuration"
  userNameField: "email"
"""
						configScripts: disableAutoUpdates: """
jenkins:
  updateCenter:
    sites: []
"""
					}
				}
				agent: {
					runAsUser: 1000
					runAsGroup: 1000
					jenkinsUrl: "http://jenkins.\(release.namespace).svc.cluster.local"
				}
				persistence: {
					enabled: true
					existingClaim: volumes.jenkins.name
				}
			}
		}
	}
}

_oauth2ClientCredentials:  "oauth2-credentials"
_oauth2ClientId: "client_id"
_oauth2ClientSecret: "client_secret"
